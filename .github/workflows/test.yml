name: demo-rerun-job
on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  actions: write   # Necesario para re-run
  contents: read

jobs:
  job1_build:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Job 1 OK"

  job2_flaky:
    runs-on: ubuntu-latest
    needs: [job1_build]
    steps:
      - name: Fail first attempt, pass on rerun
        run: |
          echo "Run attempt: ${GITHUB_RUN_ATTEMPT}"
          if [ "${GITHUB_RUN_ATTEMPT}" = "1" ]; then
            echo "Intencionalmente fallando en el primer intento..."
            exit 1
          else
            echo "Segundo intento: ahora pasa ✅"
          fi

  job3_after:
    runs-on: ubuntu-latest
    needs: [job2_flaky]
    steps:
      - run: echo "Job 3 se ejecuta cuando job2_flaky termina OK"

  auto_rerun_failed:
    # Evita loops infinitos: solo reintenta si es el primer intento del run
    if: ${{ failure() && github.run_attempt < 2 }}
    runs-on: ubuntu-latest
    needs: [job1_build, job2_flaky, job3_after]
    steps:
      # Opción 1: sin checkout, pasar el repo explícito
      - name: Re-run failed jobs (sin checkout)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh --version
          gh run rerun ${{ github.run_id }} --failed --repo "${{ github.repository }}"

      # Opción 2 (alternativa): hacer checkout para que exista .git y no necesitar --repo
      # - uses: actions/checkout@v4
      # - name: Re-run failed jobs (con checkout)
      #   env:
      #     GH_TOKEN: ${{ github.token }}
      #   run: |
      #     gh run rerun ${{ github.run_id }} --failed